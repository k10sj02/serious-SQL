# Serious SQL

![Screenshot of Data with Danny logo.](https://user-images.githubusercontent.com/81607668/128655887-038f2b02-0e9d-44b0-b632-594134bf3d56.png)

Serious SQL is one of the courses in the Data With Danny Virtual Data Apprenticeship Program.

View the course [here](https://www.datawithdanny.com/courses/serious-sql).

-------------------------------------

## üìö Table of Contents
- üõ†Ô∏è Overview
- üöÄ Solutions
- üíª Key Highlights

--------------------------------------

### üõ†Ô∏è Overview

With the Health Analytics Mini Case Study, I queried data to bring insights to the following questions:

1. How many `unique users` exist in the logs dataset?
2. How many total `measurements` do we have `per user on average`?
3. What about the `median` number of measurements per user?
4. How many users have `3 or more` measurements?
5. How many users have `1,000 or more` measurements?
6. Have logged `blood glucose` measurements?
7. Have `at least 2 types` of measurements?
8. Have all 3 measures - `blood glucose`, `weight` and `blood pressure`?
9. What is the `median systolic/diastolic` `blood pressure` values?

-----------------------------------------

### üöÄ Solutions with Explanations

**1.** **How many `unique users` exist in the logs dataset?**

```sql
SELECT
  COUNT(DISTINCT id) AS unique_users
FROM health.user_logs;
```

|unique_users                            |
|----------------------------------------|
|554                                     |

Let's break down the query:

`SELECT`: This keyword is used to specify which columns you want to retrieve from the database.

`COUNT`: This is an aggregate function in SQL that returns the number of rows that match a specified condition. In this case, it counts the number of distinct id values.

`DISTINCT`: This keyword is used to ensure that only unique values are counted. It means that if there are multiple rows with the same id, they will be treated as one. 

Please note, `DISTINCT` is not a function. It is a _modifier_ of the `SELECT` statement that tells MySQL to strip duplicate rows from the result set generated by the query. It can be used together with¬†`COUNT()`¬†aggregate function (as¬†`COUNT(DISTINCT expr`)) and it has the same meaning: it ignores the duplicates.

`id`: This is the column in the `user_logs` table whose distinct count we want to calculate.

`FROM health.user_logs`: This specifies the table (`user_logs`) and the database (`health`) from which the data should be retrieved.

When you execute this SQL query, it will return a single number representing the count of unique `id` values in the `user_logs` table of the health database.

**2.** **How many total `measurements` do we have `per user on average`?**

-- for questions 2-8 we created a temporary table

```sql
DROP TABLE IF EXISTS user_measure_count;

CREATE TEMP TABLE user_measure_count AS
SELECT
  id,
  COUNT(*) AS measure_count,
  COUNT(DISTINCT measure) as unique_measures
FROM
  health.user_logs
GROUP BY
  1;

-- Remember this does not produce a result set. To visualize temp table, run script below

SELECT *
FROM user_measure_count;
  ```

This SQL code snippet performs the following tasks:

`DROP TABLE IF EXISTS user_measure_count;`: This line drops the table named `user_measure_count` if it already exists. This is a safety measure to avoid errors in case the table already exists and needs to be recreated.

`CREATE TEMP TABLE user_measure_count AS ...`: This line creates a temporary table called `user_measure_count` to store the results of the following query. A temporary table exists only for the duration of the session and is automatically dropped when the session ends.

`SELECT ...`: This is the main SQL query that retrieves data from the `health.user_logs` table and performs calculations.

`id, COUNT(*) AS measure_count, COUNT(DISTINCT measure) as unique_measures`: The query selects the id column from the health.user_logs table and performs two aggregate functions:

`COUNT(*) AS measure_count`: This counts the total number of rows for each id group, representing the total number of measures for each user.
COUNT(DISTINCT measure) as unique_measures: This counts the number of distinct (unique) measure values for each id group, representing the unique measures recorded for each user.
FROM health.user_logs: This specifies the table health.user_logs from which the data should be retrieved.

`GROUP BY 1;`: This groups the results by the first column in the select list, which is id in this case. It means that the count results are calculated for each unique id value, so you get counts specific to each user.

After executing this code, the temporary table `user_measure_count` will hold the results of the query, containing three columns: `id, measure_count, and unique_measures`. The measure_count column will show the total count of measures for each user, and the `unique_measures` column will show the count of distinct measures recorded for each user in the `health.user_logs` table.

**3. What about the `median` number of measurements per user?**

```sql
SELECT
  ROUND(AVG(measure_count)) AS rounded_mean
FROM
  user_measure_count;
```

|rounded_mean                            |
|----------------------------------------|
|79                                      |

This SQL query calculates the rounded mean (average) of the measure_count column from the user_measure_count temporary table. Here's a breakdown of the query:

`SELECT`: This keyword is used to specify the columns or expressions that you want to retrieve from the database.

`ROUND`: This is a mathematical function in SQL that rounds a numeric value to a specified number of decimal places. In this query, it will round the average value of `measure_count` to the nearest whole number.

`AVG(measure_count)`: This is an aggregate function that calculates the average value of the `measure_count` column in the `user_measure_count` table. It adds up all the values in the measure_count column and divides the sum by the number of rows.

`AS rounded_mean`: This renames the result of the rounded mean calculation to `rounded_mean`, which will be the name of the output column.

`FROM user_measure_count`: This specifies the source table `user_measure_count` from which the data should be retrieved.

When you execute this SQL query, it will return a single row with one column, `rounded_mean`, representing the rounded mean (average) of the measure_count column from the user_measure_count temporary table.

**3. What about the `median` number of measurements per user?**

```sql
SELECT
  PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY measure_count) AS median_value
FROM user_measure_count;
```

This SQL query calculates the median value of the measure_count column from the user_measure_count temporary table using the PERCENTILE_CONT function. Let's break down the query:

`SELECT`: This keyword is used to specify the column or expression that you want to retrieve from the database.

`PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY measure_count)`: This is a window function in SQL that calculates the continuous percentile of a specified column (measure_count in this case). When PERCENTILE_CONT is called with an argument of 0.5, it calculates the median value.

`AS median_value`: This renames the result of the PERCENTILE_CONT function to median_value, which will be the name of the output column.

`FROM user_measure_count`: This specifies the source table user_measure_count from which the data should be retrieved.

When you execute this SQL query, it will return a single row with one column, `median_value`, representing the median value of the `measure_count` column from the `user_measure_count` temporary table. The median is the middle value of the sorted `measure_count` values when there is an odd number of rows, and it is the average of the two middle values when there is an even number of rows.

